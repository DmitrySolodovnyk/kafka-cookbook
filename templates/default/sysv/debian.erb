#!/bin/sh
### BEGIN INIT INFO
# Required-Start:    $remote_fs $network $named
# Required-Stop:     $remote_fs $network $named
# Default-Start:     2 3 4 5
# Default-Stop:      0 1 6
# Short-Description: <%= @daemon_name %> daemon
### END INIT INFO

NAME=<%= @daemon_name %>
USER=<%= @user %>
SCRIPTS_DIR=<%= @scripts_dir %>
PIDFILE=/var/run/$NAME.pid
RETVAL=0

# Load the VERBOSE setting and other rcS variables
[ -f /lib/init/vars.sh ] && . /lib/init/vars.sh

# Define LSB log_* functions.
# Depend on lsb-base (>= 3.2-14) to ensure that this file is present
# and status_of_proc is working.
[ -f /lib/lsb/init-functions ] && . /lib/lsb/init-functions

# Load additional configuration
[ -f <%= @env_path %> ] && . <%= @env_path %>

do_start()
{
  <% if @ulimit %>
  ulimit -n <%= @ulimit %>
  <% end %>
  start-stop-daemon --start --quiet --chuid $USER --pidfile $PIDFILE --make-pidfile --background --exec "$KAFKA_RUN" -- "$KAFKA_ARGS" "$KAFKA_CONFIG"
  RETVAL=$?
  if [ $RETVAL -eq 0 ]; then
    sync # force pidfile to be flushed to disk
    $SCRIPTS_DIR/post-start --pid="$(cat "$PIDFILE")"
    RETVAL=$?
  fi
}

do_stop()
{
  if [ -e "$PIDFILE" ]; then
    $SCRIPTS_DIR/stop --pid="$(cat "$PIDFILE")"
    RETVAL=$?
    rm -f "$PIDFILE"
  fi
}

case "$1" in
  start)
    log_daemon_msg "Starting" "$NAME"
    do_start
    case "$RETVAL" in
      0|1) log_end_msg 0 ;;
      2)   log_end_msg 1 ;;
    esac
    ;;
  stop)
    log_daemon_msg "Stopping" "$NAME"
    do_stop
    case "$RETVAL" in
      0|1) log_end_msg 0 ;;
      2)   log_end_msg 1 ;;
    esac
    ;;
  restart)
    $0 stop
    $0 start
    ;;
  status)
    status_of_proc -p $PIDFILE "$KAFKA_RUN" "$NAME" && exit 0 || exit $?
    ;;
  *)
    echo "Usage: $NAME {start|stop|restart|status}" >&2
    exit 3
    ;;
esac

exit $RETVAL
